

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>survivalstan.survivalstan &mdash; survivalstan 0.1.2.5 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="survivalstan 0.1.2.5 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> survivalstan
          

          
          </a>

          
            
            
              <div class="version">
                0.1.2.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../home.html">Survivalstan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Usage.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Examples.html">Worked examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Survivalstan API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">survivalstan</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>survivalstan.survivalstan</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for survivalstan.survivalstan</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">patsy</span>
<span class="kn">import</span> <span class="nn">stanity</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<div class="viewcode-block" id="fit_stan_survival_model"><a class="viewcode-back" href="../../survivalstan.html#survivalstan.survivalstan.fit_stan_survival_model">[docs]</a><span class="k">def</span> <span class="nf">fit_stan_survival_model</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">event_col</span><span class="p">,</span> <span class="n">model_code</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">model_cohort</span> <span class="o">=</span> <span class="s1">&#39;survival model&#39;</span><span class="p">,</span> 
                             <span class="n">time_col</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">sample_id_col</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sample_col</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">group_id_col</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">group_col</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">timepoint_id_col</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timepoint_end_col</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">make_inits</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stan_data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">grp_coef_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">FIT_FUN</span> <span class="o">=</span> <span class="n">stanity</span><span class="o">.</span><span class="n">fit</span><span class="p">,</span>
                             <span class="n">drop_intercept</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function prepares inputs appropriate for stan model model code, and fits that model using Stan.</span>

<span class="sd">    Args:</span>
<span class="sd">       df (pandas DataFrame):  The data frame containing input data to Survival model.</span>
<span class="sd">       formula (chr): Patsy formula to use for covariates. E.g &#39;met_status + pd_l1&#39;</span>
<span class="sd">       event_col (chr): name of column containing event status. Will be coerced to int</span>
<span class="sd">       model_code (chr): stan model code to use.</span>
<span class="sd">       file (chr): path to stan file (if model_code not given).</span>

<span class="sd">    Kwargs:</span>
<span class="sd">       model_cohort (chr): description of this model fit, to be used when plotting or summarizing output</span>
<span class="sd">       time_col (chr): name of column containing event time -- used for parameteric (Weibull) model</span>
<span class="sd">       sample_id_col (chr): name of column containing numeric sample ids (1-indexed &amp; sequential)</span>
<span class="sd">       sample_col (chr): name of column containing sample descriptions - will be converted to an ID</span>
<span class="sd">       group_id_col (chr): name of column containing numeric group ids (1-indexed &amp; sequential)</span>
<span class="sd">       group_col (chr): name of column containing group descriptions - will be converted to an ID </span>
<span class="sd">       timepoint_id_col (chr): name of column containing timepoint ids (1-indexed &amp; sequential)</span>
<span class="sd">       timepoint_end_col (chr): name of column containing end times for each timepoint (will be converted to an ID)</span>
<span class="sd">       stan_data (dict): extra params passed to stan data object</span>
<span class="sd">       grp_coef_type (chr): type of group coef specified, if using a varying-coef model</span>
<span class="sd">              Can be one of:</span>
<span class="sd">              - &#39;None&#39; (default): guess group coef orientation from data. </span>
<span class="sd">                                  Works except in case where M (num covariates) == G (num groups)</span>
<span class="sd">              - &#39;matrix&#39;: grp_beta defined as `matrix[M, G] grp_beta;`</span>
<span class="sd">              - &#39;vector-of-vectors&#39;: grp_beta defined as `vector[M] grp_beta[G];`</span>
<span class="sd">       drop_intercept (bool): whether to drop the intercept term from the model matrix (default: True)</span>

<span class="sd">    Returns:</span>
<span class="sd">       dictionary of results objects.  Contents::</span>

<span class="sd">          df: Pandas data frame containing input data, filtered to non-missing obs &amp; with ID variables created</span>
<span class="sd">          x_df: Covariate matrix passed to Stan</span>
<span class="sd">          x_names: Column names for the covariate matrix passed to Stan</span>
<span class="sd">          data: List passed to Stan - contains dimensions, etc.</span>
<span class="sd">          fit: pystan fit object returned from Stan call</span>
<span class="sd">          coefs: posterior draws for coefficient values</span>
<span class="sd">          loo: psis-loo object returned for fit model. Used for model comparison &amp; summary</span>
<span class="sd">          model_cohort: description of this model and/or cohort on which the model was fit</span>

<span class="sd">    Raises:</span>
<span class="sd">       AttributeError, KeyError</span>

<span class="sd">    Generic helper function for fitting variety of survival models using Stan.</span>

<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; testfit = fit_stan_survival_model(</span>
<span class="sd">                model_file = stanmodels.stan.pem_survival_model,</span>
<span class="sd">                formula = &#39;~ met_status + pd_l1&#39;,</span>
<span class="sd">                df = dflong,</span>
<span class="sd">                sample_col = &#39;patient_id&#39;,</span>
<span class="sd">                timepoint_end_col = &#39;end_time&#39;,</span>
<span class="sd">                event_col = &#39;end_failure&#39;,</span>
<span class="sd">                model_cohort = &#39;PEM survival model&#39;,</span>
<span class="sd">                iter = 30000,</span>
<span class="sd">                chains = 4,</span>
<span class="sd">            )</span>
<span class="sd">    &gt;&gt;&gt; print(testfit[&#39;fit&#39;])</span>
<span class="sd">    &gt;&gt;&gt; seaborn.boxplot(x = &#39;value&#39;, y = &#39;variable&#39;, data = testfit[&#39;coefs&#39;])</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">model_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Either model_code or file is required.&#39;</span><span class="p">)</span>
    
    <span class="c1">## input covariates given formula</span>
    <span class="n">x_df</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span>
                          <span class="n">df</span><span class="p">,</span>
                          <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;dataframe&#39;</span>
                          <span class="p">)</span>
    
    <span class="c1">## construct data frame with all necessary columns</span>
    <span class="c1">## limit to non-missing data </span>
    <span class="c1">## (if necessary) transform columns to ids</span>
    <span class="n">other_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">event_col</span><span class="p">,</span> <span class="n">time_col</span><span class="p">,</span>
                  <span class="n">group_id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span>
                  <span class="n">timepoint_id_col</span><span class="p">,</span> <span class="n">timepoint_end_col</span><span class="p">,</span>
                  <span class="n">sample_id_col</span><span class="p">,</span> <span class="n">sample_col</span><span class="p">]</span> <span class="c1">## list of possible columns to keep</span>
    
    <span class="n">other_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">other_cols</span><span class="p">))</span>
    <span class="n">other_cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">other_cols</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_cols</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="c1">## filter other inputs to non-missing observations on input covariates</span>
        <span class="n">df_nonmiss</span> <span class="o">=</span> <span class="n">x_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">other_cols</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_nonmiss</span> <span class="o">=</span> <span class="n">x_df</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">drop_intercept</span><span class="p">:</span>
        <span class="n">x_df</span> <span class="o">=</span> <span class="n">x_df</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="n">x_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s1">&#39;Intercept&#39;</span><span class="p">]</span>

    <span class="c1">## prep input dictionary to pass to stan.fit</span>
    <span class="n">survival_model_input_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_nonmiss</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
        <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x_df</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">(),</span>
        <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">df_nonmiss</span><span class="p">[</span><span class="n">event_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">time_col</span><span class="p">:</span>
        <span class="n">survival_model_input_data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nonmiss</span><span class="p">[</span><span class="n">time_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1">## construct timepoint ID vars &amp; add to input data</span>
    <span class="k">if</span> <span class="n">timepoint_end_col</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">timepoint_id_col</span><span class="p">):</span>
        <span class="n">timepoint_id_col</span> <span class="o">=</span> <span class="s1">&#39;timepoint_id&#39;</span>
        <span class="n">df_nonmiss</span><span class="p">[</span><span class="n">timepoint_id_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nonmiss</span><span class="p">[</span><span class="n">timepoint_end_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">timepoint_id_col</span><span class="p">:</span>
        <span class="n">unique_timepoints</span> <span class="o">=</span> <span class="n">_prep_timepoint_dataframe</span><span class="p">(</span><span class="n">df_nonmiss</span><span class="p">,</span>
                                                      <span class="n">timepoint_id_col</span> <span class="o">=</span> <span class="n">timepoint_id_col</span><span class="p">,</span>
                                                      <span class="n">timepoint_end_col</span> <span class="o">=</span> <span class="n">timepoint_end_col</span>
                                                      <span class="p">)</span>
        <span class="n">timepoint_input_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;t_dur&#39;</span><span class="p">:</span> <span class="n">unique_timepoints</span><span class="p">[</span><span class="s1">&#39;t_dur&#39;</span><span class="p">],</span>
            <span class="s1">&#39;t_obs&#39;</span><span class="p">:</span> <span class="n">unique_timepoints</span><span class="p">[</span><span class="n">timepoint_end_col</span><span class="p">],</span>
            <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">df_nonmiss</span><span class="p">[</span><span class="n">timepoint_id_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_nonmiss</span><span class="p">[</span><span class="n">timepoint_id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="p">}</span>
        <span class="n">survival_model_input_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">survival_model_input_data</span><span class="p">,</span> <span class="o">**</span><span class="n">timepoint_input_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">timepoint_end_col</span><span class="p">:</span>
        <span class="c1"># not required for all models, leave in for legacy</span>
        <span class="n">survival_model_input_data</span><span class="p">[</span><span class="s1">&#39;obs_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nonmiss</span><span class="p">[</span><span class="n">timepoint_end_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1">## construct sample ID var &amp; add to input data</span>
    <span class="k">if</span> <span class="n">sample_col</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">sample_id_col</span><span class="p">):</span>
        <span class="n">sample_id_col</span> <span class="o">=</span> <span class="s1">&#39;sample_id&#39;</span>
        <span class="n">df_nonmiss</span><span class="p">[</span><span class="n">sample_id_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nonmiss</span><span class="p">[</span><span class="n">sample_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">sample_id_col</span><span class="p">:</span>
        <span class="n">sample_input_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="n">df_nonmiss</span><span class="p">[</span><span class="n">sample_id_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_nonmiss</span><span class="p">[</span><span class="n">sample_id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="p">}</span>
        <span class="n">survival_model_input_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">survival_model_input_data</span><span class="p">,</span> <span class="o">**</span><span class="n">sample_input_data</span><span class="p">)</span>
 
    <span class="c1">## construct group ID var &amp; add to input data</span>
    <span class="k">if</span> <span class="n">group_col</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">group_id_col</span><span class="p">):</span>
        <span class="n">group_id_col</span> <span class="o">=</span> <span class="s1">&#39;group_id&#39;</span>
        <span class="n">df_nonmiss</span><span class="p">[</span><span class="n">group_id_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nonmiss</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">group_id_col</span><span class="p">:</span>
        <span class="n">survival_model_input_data</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nonmiss</span><span class="p">[</span><span class="n">group_id_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">survival_model_input_data</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_nonmiss</span><span class="p">[</span><span class="n">group_id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        
    <span class="k">if</span> <span class="n">stan_data</span><span class="p">:</span>
        <span class="n">survival_model_input_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">survival_model_input_data</span><span class="p">,</span> <span class="o">**</span><span class="n">stan_data</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">make_inits</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">init</span> <span class="o">=</span> <span class="n">make_inits</span><span class="p">(</span><span class="n">survival_model_input_data</span><span class="p">))</span>
    
    <span class="n">survival_fit</span> <span class="o">=</span> <span class="n">FIT_FUN</span><span class="p">(</span>
        <span class="n">model_code</span> <span class="o">=</span> <span class="n">model_code</span><span class="p">,</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">,</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">survival_model_input_data</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">beta_coefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">survival_fit</span><span class="o">.</span><span class="n">extract</span><span class="p">()[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">x_df</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">)</span>
        <span class="n">beta_coefs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">beta_coefs</span> <span class="o">=</span> <span class="n">beta_coefs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;iter&#39;</span><span class="p">})</span>
        <span class="n">beta_coefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">beta_coefs</span><span class="p">,</span> <span class="n">id_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">])</span>
        <span class="n">beta_coefs</span><span class="p">[</span><span class="s1">&#39;exp(beta)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">beta_coefs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="n">beta_coefs</span><span class="p">[</span><span class="s1">&#39;model_cohort&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_cohort</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">beta_coefs</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1">## prep by-group coefs if group specified</span>
    <span class="k">if</span> <span class="n">group_id_col</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">group_col</span><span class="p">:</span>
                <span class="n">grp_names</span> <span class="o">=</span> <span class="n">df_nonmiss</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="o">~</span><span class="n">df_nonmiss</span><span class="p">[[</span><span class="n">group_id_col</span><span class="p">]]</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">group_id_col</span><span class="p">)[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grp_names</span> <span class="o">=</span> <span class="n">df_nonmiss</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="o">~</span><span class="n">df_nonmiss</span><span class="p">[[</span><span class="n">group_id_col</span><span class="p">]]</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">group_id_col</span><span class="p">)[</span><span class="n">group_id_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">grp_coefs</span> <span class="o">=</span> <span class="n">_extract_grp_coefs</span><span class="p">(</span><span class="n">survival_fit</span><span class="o">=</span><span class="n">survival_fit</span><span class="p">,</span>
                                           <span class="n">element</span><span class="o">=</span><span class="s1">&#39;grp_beta&#39;</span><span class="p">,</span>
                                           <span class="n">grp_coef_type</span><span class="o">=</span><span class="n">grp_coef_type</span><span class="p">,</span>
                                           <span class="n">grp_names</span><span class="o">=</span><span class="n">grp_names</span><span class="p">,</span>
                                           <span class="n">columns</span><span class="o">=</span><span class="n">x_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                           <span class="n">input_data</span><span class="o">=</span><span class="n">survival_model_input_data</span><span class="p">,</span>
                                           <span class="n">model_cohort</span><span class="o">=</span><span class="n">model_cohort</span>
                                          <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">grp_coefs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grp_coefs</span> <span class="o">=</span> <span class="n">beta_coefs</span>
        <span class="k">if</span> <span class="n">grp_coefs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grp_coefs</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Overall&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">loo</span> <span class="o">=</span> <span class="n">stanity</span><span class="o">.</span><span class="n">psisloo</span><span class="p">(</span><span class="n">survival_fit</span><span class="o">.</span><span class="n">extract</span><span class="p">()[</span><span class="s1">&#39;log_lik&#39;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">loo</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sample_id_col</span><span class="p">:</span>
        <span class="n">sample_id_col</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sample_col</span><span class="p">:</span>
        <span class="n">sample_col</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">timepoint_id_col</span><span class="p">:</span>
        <span class="n">timepoint_id_col</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">timepoint_end_col</span><span class="p">:</span>
        <span class="n">timepoint_end_col</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;df&#39;</span><span class="p">:</span> <span class="n">df_nonmiss</span><span class="p">,</span>
        <span class="s1">&#39;x_df&#39;</span><span class="p">:</span> <span class="n">x_df</span><span class="p">,</span>
        <span class="s1">&#39;x_names&#39;</span><span class="p">:</span> <span class="n">x_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
        <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">survival_model_input_data</span><span class="p">,</span>
        <span class="s1">&#39;fit&#39;</span><span class="p">:</span> <span class="n">survival_fit</span><span class="p">,</span>
        <span class="s1">&#39;coefs&#39;</span><span class="p">:</span> <span class="n">beta_coefs</span><span class="p">,</span>
        <span class="s1">&#39;grp_coefs&#39;</span><span class="p">:</span> <span class="n">grp_coefs</span><span class="p">,</span>
        <span class="s1">&#39;loo&#39;</span><span class="p">:</span> <span class="n">loo</span><span class="p">,</span>
        <span class="s1">&#39;model_cohort&#39;</span><span class="p">:</span> <span class="n">model_cohort</span><span class="p">,</span>
        <span class="s1">&#39;df_all&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">,</span>
        <span class="s1">&#39;sample_col&#39;</span><span class="p">:</span> <span class="n">sample_col</span><span class="p">,</span>
        <span class="s1">&#39;sample_id_col&#39;</span><span class="p">:</span> <span class="n">sample_id_col</span><span class="p">,</span>
        <span class="s1">&#39;timepoint_id_col&#39;</span><span class="p">:</span> <span class="n">timepoint_id_col</span><span class="p">,</span>
        <span class="s1">&#39;timepoint_end_col&#39;</span><span class="p">:</span> <span class="n">timepoint_end_col</span><span class="p">,</span>
    <span class="p">}</span></div>


<span class="k">def</span> <span class="nf">_extract_grp_coefs</span><span class="p">(</span><span class="n">survival_fit</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">grp_coef_type</span><span class="p">,</span> <span class="n">grp_names</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">model_cohort</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper function to extract grp coefs summary data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grp_coefs_extract</span> <span class="o">=</span> <span class="n">survival_fit</span><span class="o">.</span><span class="n">extract</span><span class="p">()[</span><span class="n">element</span><span class="p">]</span>
    
    <span class="c1">## try to guess shape of group-betas</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">grp_coef_type</span><span class="p">):</span>
        <span class="n">grp_coef_type</span> <span class="o">=</span> <span class="n">_guess_grp_coef_type</span><span class="p">(</span><span class="n">extract</span><span class="o">=</span><span class="n">grp_coefs_extract</span><span class="p">,</span>
                                             <span class="n">input_data</span><span class="o">=</span><span class="n">input_data</span><span class="p">)</span>
        
    <span class="c1">## process group_coefs according to type</span>
    <span class="k">if</span> <span class="n">grp_coef_type</span> <span class="o">==</span> <span class="s1">&#39;matrix&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">grp_coefs_data</span> <span class="o">=</span> <span class="n">_format_grp_coefs_matrix</span><span class="p">(</span><span class="n">extract</span><span class="o">=</span><span class="n">grp_coefs_extract</span><span class="p">,</span>
                                                      <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                                                      <span class="n">grp_names</span><span class="o">=</span><span class="n">grp_names</span>
                                                     <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;unable to format grp coefs as matrix&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">grp_coef_type</span> <span class="o">==</span> <span class="s1">&#39;vector-of-vectors&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">grp_coefs_data</span> <span class="o">=</span> <span class="n">_format_grp_coefs_vectors</span><span class="p">(</span><span class="n">extract</span><span class="o">=</span><span class="n">grp_coefs_extract</span><span class="p">,</span>
                                                       <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                                                       <span class="n">grp_names</span><span class="o">=</span><span class="n">grp_names</span>
                                                      <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;unable to format grp coefs as vector-of-vectors&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">grp_coef_type</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;warning: unable to determine group-coef orientation. Try using arg `grp_coef_type`&quot;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid `grp_coef_type` -- must be one of &#39;vector-of-vectors&#39; or &#39;matrix&#39;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping grp coef extraction for now.&quot;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    
    <span class="c1"># process/format grp_coefs data</span>
    <span class="n">grp_coefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">grp_coefs_data</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span><span class="s1">&#39;iter&#39;</span><span class="p">])</span>
    <span class="n">grp_coefs</span><span class="p">[</span><span class="s1">&#39;exp(beta)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">grp_coefs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
    <span class="n">grp_coefs</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp_coefs</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
    <span class="n">grp_coefs</span><span class="p">[</span><span class="s1">&#39;model_cohort&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_cohort</span>
    <span class="k">return</span><span class="p">(</span><span class="n">grp_coefs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_format_grp_coefs_matrix</span><span class="p">(</span><span class="n">extract</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">grp_names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper function for format grp_coefs data if in `matrix[M, G]` form</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grp_coefs_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grp_names</span><span class="p">:</span>
        <span class="n">grp_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">extract</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">)</span>
        <span class="n">grp_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">grp_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;iter&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">grp_data</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp</span>
        <span class="n">grp_coefs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grp_data</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">grp_coefs_data</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_format_grp_coefs_vectors</span><span class="p">(</span><span class="n">extract</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">grp_names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper function for format grp_coefs data if in `vector[M] grp_beta[G]` form</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grp_coefs_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grp_names</span><span class="p">:</span>
        <span class="n">grp_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">extract</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">)</span>
        <span class="n">grp_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">grp_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;iter&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">grp_data</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp</span>
        <span class="n">grp_coefs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grp_data</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">grp_coefs_data</span><span class="p">))</span>
    

<span class="k">def</span> <span class="nf">_guess_grp_coef_type</span><span class="p">(</span><span class="n">extract</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper function to determine grp_coefs type from shape of returned object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]:</span>
        <span class="c1"># unable to determine shape if M == G</span>
        <span class="n">grp_coef_type</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="k">elif</span> <span class="n">extract</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]:</span>
        <span class="n">grp_coef_type</span> <span class="o">=</span> <span class="s1">&#39;vector-of-vectors&#39;</span>
    <span class="k">elif</span> <span class="n">extract</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]:</span>
        <span class="n">grp_coef_type</span> <span class="o">=</span> <span class="s1">&#39;matrix&#39;</span>
    <span class="k">return</span> <span class="n">grp_coef_type</span>

<span class="k">def</span> <span class="nf">_prep_timepoint_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                              <span class="n">timepoint_end_col</span><span class="p">,</span>
                              <span class="n">timepoint_id_col</span> <span class="o">=</span> <span class="kc">None</span>
                              <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper function to take a set of timepoints </span>
<span class="sd">        in observation-level dataframe &amp; return </span>
<span class="sd">        formatted timepoint_id, end_time, duration </span>

<span class="sd">        Returns</span>
<span class="sd">        ---------</span>
<span class="sd">        pandas dataframe with one record per timepoint_id</span>
<span class="sd">            where timepoint_id is the index</span>
<span class="sd">            sorted on the index, increasing</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">time_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">timepoint_end_col</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">timepoint_id_col</span><span class="p">):</span>
        <span class="n">timepoint_id_col</span> <span class="o">=</span> <span class="s1">&#39;timepoint_id&#39;</span>
        <span class="n">time_df</span><span class="p">[</span><span class="n">timepoint_id_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_df</span><span class="p">[</span><span class="n">timepoint_end_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span> <span class="o">+</span> <span class="mi">1</span>        
    <span class="n">time_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">timepoint_id_col</span><span class="p">,</span> <span class="n">timepoint_end_col</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">time_df</span> <span class="o">=</span> <span class="n">time_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="n">timepoint_id_col</span><span class="p">,</span> <span class="n">timepoint_end_col</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">time_df</span><span class="p">[</span><span class="n">timepoint_end_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_df</span><span class="p">[</span><span class="n">timepoint_end_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">time_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">timepoint_id_col</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">time_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t_durs</span> <span class="o">=</span> <span class="n">time_df</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">t_durs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">timepoint_end_col</span><span class="p">:</span> <span class="s1">&#39;t_dur&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">time_df</span> <span class="o">=</span> <span class="n">time_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t_durs</span><span class="p">)</span>
    <span class="n">time_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">time_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">timepoint_end_col</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">time_df</span><span class="p">)</span>


<div class="viewcode-block" id="extract_grp_baseline_hazard"><a class="viewcode-back" href="../../survivalstan.html#survivalstan.survivalstan.extract_grp_baseline_hazard">[docs]</a><span class="k">def</span> <span class="nf">extract_grp_baseline_hazard</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">timepoint_id_col</span> <span class="o">=</span> <span class="s1">&#39;timepoint_id&#39;</span><span class="p">,</span> <span class="n">timepoint_end_col</span> <span class="o">=</span> <span class="s1">&#39;end_time&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; If model results contain a grp_baseline object, extract &amp; summarize it</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## TODO check if results are by-group</span>
    <span class="c1">## TODO check if baseline hazard is computable</span>
    <span class="n">grp_baseline_extract</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;fit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()[</span><span class="s1">&#39;grp_baseline&#39;</span><span class="p">]</span>
    <span class="n">coef_group_names</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;grp_coefs&#39;</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">grp_baseline_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">coef_group_names</span><span class="p">:</span>
        <span class="n">grp_base</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grp_baseline_extract</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">grp_base_coefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">grp_base</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="n">timepoint_id_col</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;baseline_hazard&#39;</span><span class="p">)</span>
        <span class="n">grp_base_coefs</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grp</span>
        <span class="n">grp_baseline_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grp_base_coefs</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">grp_baseline_coefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">grp_baseline_data</span><span class="p">)</span>
    <span class="n">end_times</span> <span class="o">=</span> <span class="n">_extract_timepoint_end_times</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">timepoint_id_col</span> <span class="o">=</span> <span class="n">timepoint_id_col</span><span class="p">,</span> <span class="n">timepoint_end_col</span> <span class="o">=</span> <span class="n">timepoint_end_col</span><span class="p">)</span>
    <span class="n">bs_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">grp_baseline_coefs</span><span class="p">,</span> <span class="n">end_times</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="n">timepoint_id_col</span><span class="p">)</span> 
    <span class="k">return</span><span class="p">(</span><span class="n">bs_data</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_extract_timepoint_end_times</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">timepoint_end_col</span> <span class="o">=</span> <span class="s1">&#39;end_time&#39;</span><span class="p">,</span> <span class="n">timepoint_id_col</span> <span class="o">=</span> <span class="s1">&#39;timepoint_id&#39;</span><span class="p">):</span>
    <span class="n">df_nonmiss</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;df&#39;</span><span class="p">]</span>
    <span class="n">end_times</span> <span class="o">=</span> <span class="n">df_nonmiss</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df_nonmiss</span><span class="p">[[</span><span class="n">timepoint_id_col</span><span class="p">]]</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">timepoint_id_col</span><span class="p">)[[</span><span class="n">timepoint_end_col</span><span class="p">,</span> <span class="n">timepoint_id_col</span><span class="p">]]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">end_times</span><span class="p">)</span>

<div class="viewcode-block" id="extract_baseline_hazard"><a class="viewcode-back" href="../../survivalstan.html#survivalstan.survivalstan.extract_baseline_hazard">[docs]</a><span class="k">def</span> <span class="nf">extract_baseline_hazard</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="s1">&#39;baseline&#39;</span><span class="p">,</span> <span class="n">timepoint_id_col</span> <span class="o">=</span> <span class="s1">&#39;timepoint_id&#39;</span><span class="p">,</span> <span class="n">timepoint_end_col</span> <span class="o">=</span> <span class="s1">&#39;end_time&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; If model results contain a baseline object, extract &amp; summarize it</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">## TODO check if baseline hazard is computable</span>
    <span class="n">baseline_extract</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;fit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()[</span><span class="n">element</span><span class="p">]</span>
    <span class="n">baseline_coefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">baseline_extract</span><span class="p">)</span>
    <span class="n">bs_coefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">baseline_coefs</span><span class="p">,</span> <span class="n">var_name</span> <span class="o">=</span> <span class="n">timepoint_id_col</span><span class="p">,</span> <span class="n">value_name</span> <span class="o">=</span> <span class="s1">&#39;baseline_hazard&#39;</span><span class="p">)</span>
    <span class="n">end_times</span> <span class="o">=</span> <span class="n">_extract_timepoint_end_times</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">timepoint_id_col</span> <span class="o">=</span> <span class="n">timepoint_id_col</span><span class="p">,</span> <span class="n">timepoint_end_col</span> <span class="o">=</span> <span class="n">timepoint_end_col</span><span class="p">)</span>
    <span class="n">bs_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">bs_coefs</span><span class="p">,</span> <span class="n">end_times</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="n">timepoint_id_col</span><span class="p">)</span>
    <span class="n">bs_data</span><span class="p">[</span><span class="s1">&#39;model_cohort&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;model_cohort&#39;</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">bs_data</span><span class="p">)</span></div>

<span class="c1">## convert wide survival data to long format</span>
<div class="viewcode-block" id="prep_data_long_surv"><a class="viewcode-back" href="../../survivalstan.html#survivalstan.survivalstan.prep_data_long_surv">[docs]</a><span class="k">def</span> <span class="nf">prep_data_long_surv</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">time_col</span><span class="p">,</span> <span class="n">event_col</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; convert wide survival data to long format</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">## identify distinct failure/censor times</span>
    <span class="n">failure_times</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">time_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">ftimes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;end_time&#39;</span><span class="p">:</span> <span class="n">failure_times</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
    
    <span class="c1">## cross join failure times with each observation</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">dflong</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ftimes</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;key&#39;</span><span class="p">)</span>
    
    <span class="c1">## identify end-time &amp; end-status for each sample*failure time</span>
    <span class="k">def</span> <span class="nf">gen_end_failure</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">time_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]:</span>
            <span class="c1">## event not yet occurred (time_col is after this timepoint)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">time_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]:</span>
            <span class="c1">## event during (==) this timepoint</span>
            <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">event_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">time_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]:</span>
            <span class="c1">## event already occurred (time_col is before this timepoint)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">dflong</span><span class="p">[</span><span class="s1">&#39;end_failure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dflong</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">gen_end_failure</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">## confirm total number of non-censor events hasn&#39;t changed</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dflong</span><span class="o">.</span><span class="n">end_failure</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">event_col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: total number of events has changed from </span><span class="si">{0}</span><span class="s1"> to </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">event_col</span><span class="p">]),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dflong</span><span class="o">.</span><span class="n">end_failure</span><span class="p">)))</span>

    
    <span class="c1">## remove timepoints after failure/censor event</span>
    <span class="n">dflong</span> <span class="o">=</span> <span class="n">dflong</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;end_time &lt;= </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_col</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">dflong</span><span class="p">)</span></div>

<div class="viewcode-block" id="make_weibull_survival_model_inits"><a class="viewcode-back" href="../../survivalstan.html#survivalstan.survivalstan.make_weibull_survival_model_inits">[docs]</a><span class="k">def</span> <span class="nf">make_weibull_survival_model_inits</span><span class="p">(</span><span class="n">stan_input_dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tau_s_raw&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;tau_raw&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stan_input_dict</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">])),</span>
            <span class="s1">&#39;alpha_raw&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="s1">&#39;beta_raw&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stan_input_dict</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;mu&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">m</span>
    <span class="k">return</span> <span class="n">f</span></div>

</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Jacki Novik.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1.2.5',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>